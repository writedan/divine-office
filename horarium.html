<script>
function isObject(item){return(item&&typeof item==='object'&&!Array.isArray(item))}function mergeDeep(target,...sources){if(!sources.length){return target}const source=sources.shift();if(isObject(target)&&isObject(source)){for(const key in source){if(isObject(source[key])){if(!target[key]){Object.assign(target,{[key]:{}})}mergeDeep(target[key],source[key])}else{Object.assign(target,{[key]:source[key]})}}}return mergeDeep(target,...sources)}

    /*
 (c) 2011-2015, Vladimir Agafonkin
 SunCalc is a JavaScript library for calculating sun/moon position and light phases.
 https://github.com/mourner/suncalc
*/
    (function () {
        "use strict";
        var PI = Math.PI,
            sin = Math.sin,
            cos = Math.cos,
            tan = Math.tan,
            asin = Math.asin,
            atan = Math.atan2,
            acos = Math.acos,
            rad = PI / 180;
        var dayMs = 1000 * 60 * 60 * 24,
            J1970 = 2440588,
            J2000 = 2451545;
        function toJulian(date) {
            return date.valueOf() / dayMs - 0.5 + J1970;
        }
        function fromJulian(j) {
            return new Date((j + 0.5 - J1970) * dayMs);
        }
        function toDays(date) {
            return toJulian(date) - J2000;
        }
        var e = rad * 23.4397;
        function rightAscension(l, b) {
            return atan(sin(l) * cos(e) - tan(b) * sin(e), cos(l));
        }
        function declination(l, b) {
            return asin(sin(b) * cos(e) + cos(b) * sin(e) * sin(l));
        }
        function azimuth(H, phi, dec) {
            return atan(sin(H), cos(H) * sin(phi) - tan(dec) * cos(phi));
        }
        function altitude(H, phi, dec) {
            return asin(sin(phi) * sin(dec) + cos(phi) * cos(dec) * cos(H));
        }
        function siderealTime(d, lw) {
            return rad * (280.16 + 360.9856235 * d) - lw;
        }
        function astroRefraction(h) {
            if (h < 0) {
                h = 0;
            }
            return 0.0002967 / Math.tan(h + 0.00312536 / (h + 0.08901179));
        }
        function solarMeanAnomaly(d) {
            return rad * (357.5291 + 0.98560028 * d);
        }
        function eclipticLongitude(M) {
            var C = rad * (1.9148 * sin(M) + 0.02 * sin(2 * M) + 0.0003 * sin(3 * M)),
                P = rad * 102.9372;
            return M + C + P + PI;
        }
        function sunCoords(d) {
            var M = solarMeanAnomaly(d),
                L = eclipticLongitude(M);
            return { dec: declination(L, 0), ra: rightAscension(L, 0) };
        }
        var SunCalc = {};
        SunCalc.getPosition = function (date, lat, lng) {
            var lw = rad * -lng,
                phi = rad * lat,
                d = toDays(date),
                c = sunCoords(d),
                H = siderealTime(d, lw) - c.ra;
            return { azimuth: azimuth(H, phi, c.dec), altitude: altitude(H, phi, c.dec) };
        };
        var times = (SunCalc.times = [
            [-0.833, "sunrise", "sunset"],
            [-0.3, "sunriseEnd", "sunsetStart"],
            [-6, "dawn", "dusk"],
            [-12, "nauticalDawn", "nauticalDusk"],
            [-18, "nightEnd", "night"],
            [6, "goldenHourEnd", "goldenHour"],
        ]);
        SunCalc.addTime = function (angle, riseName, setName) {
            times.push([angle, riseName, setName]);
        };
        var J0 = 0.0009;
        function julianCycle(d, lw) {
            return Math.round(d - J0 - lw / (2 * PI));
        }
        function approxTransit(Ht, lw, n) {
            return J0 + (Ht + lw) / (2 * PI) + n;
        }
        function solarTransitJ(ds, M, L) {
            return J2000 + ds + 0.0053 * sin(M) - 0.0069 * sin(2 * L);
        }
        function hourAngle(h, phi, d) {
            return acos((sin(h) - sin(phi) * sin(d)) / (cos(phi) * cos(d)));
        }
        function observerAngle(height) {
            return (-2.076 * Math.sqrt(height)) / 60;
        }
        function getSetJ(h, lw, phi, dec, n, M, L) {
            var w = hourAngle(h, phi, dec),
                a = approxTransit(w, lw, n);
            return solarTransitJ(a, M, L);
        }
        SunCalc.getTimes = function (date, lat, lng, height) {
            height = height || 0;
            var lw = rad * -lng,
                phi = rad * lat,
                dh = observerAngle(height),
                d = toDays(date),
                n = julianCycle(d, lw),
                ds = approxTransit(0, lw, n),
                M = solarMeanAnomaly(ds),
                L = eclipticLongitude(M),
                dec = declination(L, 0),
                Jnoon = solarTransitJ(ds, M, L),
                i,
                len,
                time,
                h0,
                Jset,
                Jrise;
            var result = { solarNoon: fromJulian(Jnoon), nadir: fromJulian(Jnoon - 0.5) };
            for (i = 0, len = times.length; i < len; i += 1) {
                time = times[i];
                h0 = (time[0] + dh) * rad;
                Jset = getSetJ(h0, lw, phi, dec, n, M, L);
                Jrise = Jnoon - (Jset - Jnoon);
                result[time[1]] = fromJulian(Jrise);
                result[time[2]] = fromJulian(Jset);
            }
            return result;
        };
        function moonCoords(d) {
            var L = rad * (218.316 + 13.176396 * d),
                M = rad * (134.963 + 13.064993 * d),
                F = rad * (93.272 + 13.22935 * d),
                l = L + rad * 6.289 * sin(M),
                b = rad * 5.128 * sin(F),
                dt = 385001 - 20905 * cos(M);
            return { ra: rightAscension(l, b), dec: declination(l, b), dist: dt };
        }
        SunCalc.getMoonPosition = function (date, lat, lng) {
            var lw = rad * -lng,
                phi = rad * lat,
                d = toDays(date),
                c = moonCoords(d),
                H = siderealTime(d, lw) - c.ra,
                h = altitude(H, phi, c.dec),
                pa = atan(sin(H), tan(phi) * cos(c.dec) - sin(c.dec) * cos(H));
            h = h + astroRefraction(h);
            return { azimuth: azimuth(H, phi, c.dec), altitude: h, distance: c.dist, parallacticAngle: pa };
        };
        SunCalc.getMoonIllumination = function (date) {
            var d = toDays(date || new Date()),
                s = sunCoords(d),
                m = moonCoords(d),
                sdist = 149598000,
                phi = acos(sin(s.dec) * sin(m.dec) + cos(s.dec) * cos(m.dec) * cos(s.ra - m.ra)),
                inc = atan(sdist * sin(phi), m.dist - sdist * cos(phi)),
                angle = atan(cos(s.dec) * sin(s.ra - m.ra), sin(s.dec) * cos(m.dec) - cos(s.dec) * sin(m.dec) * cos(s.ra - m.ra));
            return { fraction: (1 + cos(inc)) / 2, phase: 0.5 + (0.5 * inc * (angle < 0 ? -1 : 1)) / Math.PI, angle: angle };
        };
        function hoursLater(date, h) {
            return new Date(date.valueOf() + (h * dayMs) / 24);
        }
        SunCalc.getMoonTimes = function (date, lat, lng, inUTC) {
            var t = new Date(date);
            if (inUTC) {
                t.setUTCHours(0, 0, 0, 0);
            } else {
                t.setHours(0, 0, 0, 0);
            }
            var hc = 0.133 * rad,
                h0 = SunCalc.getMoonPosition(t, lat, lng).altitude - hc,
                h1,
                h2,
                rise,
                set,
                a,
                b,
                xe,
                ye,
                d,
                roots,
                x1,
                x2,
                dx;
            for (var i = 1; i <= 24; i += 2) {
                h1 = SunCalc.getMoonPosition(hoursLater(t, i), lat, lng).altitude - hc;
                h2 = SunCalc.getMoonPosition(hoursLater(t, i + 1), lat, lng).altitude - hc;
                a = (h0 + h2) / 2 - h1;
                b = (h2 - h0) / 2;
                xe = -b / (2 * a);
                ye = (a * xe + b) * xe + h1;
                d = b * b - 4 * a * h1;
                roots = 0;
                if (d >= 0) {
                    dx = Math.sqrt(d) / (Math.abs(a) * 2);
                    x1 = xe - dx;
                    x2 = xe + dx;
                    if (Math.abs(x1) <= 1) {
                        roots += 1;
                    }
                    if (Math.abs(x2) <= 1) {
                        roots += 1;
                    }
                    if (x1 < -1) {
                        x1 = x2;
                    }
                }
                if (roots === 1) {
                    if (h0 < 0) {
                        rise = i + x1;
                    } else {
                        set = i + x1;
                    }
                } else if (roots === 2) {
                    rise = i + (ye < 0 ? x2 : x1);
                    set = i + (ye < 0 ? x1 : x2);
                }
                if (rise && set) {
                    break;
                }
                h0 = h2;
            }
            var result = {};
            if (rise) {
                result.rise = hoursLater(t, rise);
            }
            if (set) {
                result.set = hoursLater(t, set);
            }
            if (!rise && !set) {
                result[ye > 0 ? "alwaysUp" : "alwaysDown"] = true;
            }
            return result;
        };
        if (typeof exports === "object" && typeof module !== "undefined") {
            module.exports = SunCalc;
        } else if (typeof define === "function" && define.amd) {
            define(SunCalc);
        } else {
            window.SunCalc = SunCalc;
        }
    })();
</script>

<script>
    // this is the definitons script
    function computus(y) {
        var date, a, b, c, m, d;
        date = new Date();
        date.setHours(0, 0, 0, 0);
        date.setFullYear(y);
        a = y % 19;
        b = 2200 <= y && y <= 2299 ? (11 * a + 4) % 30 : (11 * a + 5) % 30;
        c = b === 0 || (b === 1 && a > 10) ? b + 1 : b;
        m = 1 <= c && c <= 19 ? 3 : 2;
        d = (50 - c) % 31;
        date.setMonth(m, d);
        date.setMonth(m, d + (7 - date.getDay()));
        return date;
    }
    function computus2(y) {
        var nov27 = new Date();
        nov27.setFullYear(y);
        nov27.setMonth(11 - 1);
        nov27.setDate(27);
        while (nov27.getDay() != 0) {
            nov27.setDate(nov27.getDate() + 1);
        }
        return nov27;
    }
    function dateToSuntime(dat) {
        var hour = dat.getHours();
        var mint = dat.getMinutes();
        return hour + mint / 60;
    }
    function w_sunrise(lat, lon, dat) {
        return dateToSuntime(SunCalc.getTimes(dat, lat, lon).sunrise);
    }
    function w_sunset(lat, lon, dat) {
        return dateToSuntime(SunCalc.getTimes(dat, lat, lon).sunset);
    }
    const roundNearest = (value, nearest) => Math.round(value * (1 / nearest)) / (1 / nearest);
    function roundTime(time) {
        time = roundNearest(time, 15 / 60);
        if (time > 24) {
            time -= 24;
        }
        if (time < 0) {
            time += 24;
        }
        return time;
    }
    function suntimeToClocktime(suntime) {
        if (suntime > 24) suntime -= 24
        return [Math.floor(suntime), Math.floor((suntime - Math.floor(suntime)) * 60)];
    }
    function printClocktime(clocktime) {
        //if (clocktime[0] >= 24) clocktime[0] -= 24;
        let am = clocktime[0] < 12;
        clocktime[0] = am ? clocktime[0] : clocktime[0] - 12;
        if (clocktime[0] == 0) {
            clocktime[0] = 12;
        }
        return (clocktime[0] < 10 ? "" : "") + clocktime[0] + ":" + (clocktime[1] < 10 ? "0" + clocktime[1] : clocktime[1]) + (clocktime[0] < 10 ? " " : " ") + (am ? "AM" : "PM");
    }

    function getFormattedDate(date) {
  var year = date.getFullYear();

  var month = (1 + date.getMonth()).toString();
  month = month.length > 1 ? month : '0' + month;

  var day = date.getDate().toString();
  day = day.length > 1 ? day : '0' + day;
  
  return year + '/' + month + '/' + day;
}

    function printDuration(suntime) {
        var n = suntimeToClocktime(suntime);
        return (n[0] > 0 ? n[0] + "hr" : "") + (n[1] > 0 ? n[1] + "min" : "");
    }

    function romanize (num) {
    if (isNaN(num))
        return NaN;
    var digits = String(+num).split(""),
        key = ["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM",
               "","X","XX","XXX","XL","L","LX","LXX","LXXX","XC",
               "","I","II","III","IV","V","VI","VII","VIII","IX"],
        roman = "",
        i = 3;
    while (i--)
        roman = (key[+digits.pop() + (i * 10)] || "") + roman;
    return Array(+digits.join("") + 1).join("M") + roman;
}

    function initBoxes(lat, lon) {
        var latBox = document.getElementById("lat");
        var lonBox = document.getElementById("lon");
        var datBox = document.getElementById("dat");

        var today = new Date();
        today = new Date(today.toDateString());

        console.log(today)

        datBox.valueAsDate = today;
        latBox.value = lat;
        lonBox.value = lon;
        latBox.onchange = (event) => boxChanged(latBox, lonBox, datBox);
        lonBox.onchange = (event) => boxChanged(latBox, lonBox, datBox);
        datBox.onchange = (event) => boxChanged(latBox, lonBox, datBox);
        boxChanged(latBox, lonBox, datBox);
    }

    function getHorariumTable(hours, separate, secondVespers=false) {
    	console.log("separate = " + separate, "secondVespers = " + secondVespers);
        let table = document.createElement("table");
        table.border = "0";
        table.style.borderCollapse = "collapse";
        table.style.width = "300px";
        let tr = document.createElement("tr");
        tr.style.width = "100%";
        let timeth = document.createElement("th");
        timeth.style.width = "33%";
        timeth.innerHTML = "Time";
        timeth.align = "left";
        tr.append(timeth);
        let hourth = document.createElement("th");
        hourth.style.width = "66%";
        hourth.innerHTML = "Hour";
        hourth.align = "left";
        tr.append(hourth);
        /*let liturgyth = document.createElement('th');
        liturgyth.style.width = '65%';
        liturgyth.innerHTML = 'Liturgy';
        liturgyth.align = 'left';
        tr.append(liturgyth);*/
        table.append(tr);
        {
            for (i = 0; i < Object.keys(hours).length; i += 1) {
                name = Object.keys(hours)[i];
                if (name == 'Vespers' && i == 0) break;
                hour = hours[name];
                nextHour = i + 1;
                if (nextHour == Object.keys(hours).length) {
                    nextHour = 0;
                }
                elapse = hours[Object.keys(hours)[nextHour]].time - hour.time;
                elapse -= hour.duration;
                if (elapse < 0) {
                    elapse += 24;
                }
                console.log("Time elapse from " + name + " to " + Object.keys(hours)[nextHour] + ": " + printDuration(elapse));
            }
        }
        for (hour in hours) {
            if (hour == 'Vespers' || hour == 'Compline') {
                if (separate) continue;
            }

            let time = suntimeToClocktime(hours[hour].time);
            let tr = document.createElement("tr");
            let timetd = document.createElement("td");
            timetd.innerHTML = printClocktime(time);
            tr.append(timetd);
            let dur = suntimeToClocktime(hours[hour].time + hours[hour].duration);
            timetd.innerHTML/* += "<br/>" + printClocktime(dur);*/
            let hourtd = document.createElement("td");
            hourtd.innerHTML = "<a href='?hour=" + hour + "&date=" + getFormattedDate(new Date(hours[hour].liturgy.date)) + "'>" + hour + "</a>";
            if (hours.Vigils === undefined) {
                if (hour == 'Vespers' && !secondVespers) {
                    hourtd.innerHTML = "<a href='?hour=FirstVespers&date=" + getFormattedDate(new Date(hours[hour].liturgy.date)) + "'>First Vespers. </a>";
                }
            }
            tr.append(hourtd);
            tr.style.width = "100%";
            timetd.style.width = "10%";
            hourtd.style.width = "10%";
            hourtd.style.verticalAlign ='top'
            timetd.style.verticalAlign ='top'
            let liturgytd = document.createElement('td');
            liturgytd.style.verticalAlign ='top'
            var metadata = hours[hour].metadata;

            hourtd.innerHTML += '<br/>'

            // Mass, Dinner, and Supper ought go last
            if (metadata.penance == 'fast' || metadata.penance == 'strict-fast') {
                if (hour == 'Sext') {
                    hourtd.innerHTML += '<span class="info"><i>Mass.</i></span>';
                }
                if (hour == 'Vespers') {
                    hourtd.innerHTML += '<span class="info"><i>Dinner.</i></span>'
                }
            } else if (metadata.penance == 'vigil') {
                if (hour == 'None') {
                    hourtd.innerHTML += '<span class="info"><i>Mass.</i></span>'
                }
                if (hour == 'Vespers') {
                    hourtd.innerHTML += '<span class="info"><i>Supper.</i></span>'
                }
            } else {
                if (hour == 'Terce') {
                    hourtd.innerHTML += '<span class="info"><i>Mass.</i></span>'
                }
                if (hour == 'Sext') {
                    hourtd.innerHTML += '<span class="info"><i>Dinner.</i></span>'
                }
                if (hour == 'Vespers') {
                    hourtd.innerHTML += '<span class="info"><i>Supper.</i></span>'
                }
            }

            //hourtd.innerHTML += '<br/>'
            let span = document.createElement('span');
            //span.style.color = metadata.color;
            /*if (metadata.color == 'white') {
                span.style.textShadow = '1px 1px 0 #000,-1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000'
            }

            if (metadata.color == 'black') {
                span.style.fontWeight = 999
                span.style.textShadow = '0.1px 0.1px 0 #000,-0.1px 0.1px 0 #000, -0.1px -0.1px 0 #000, 0.1px -0.1px 0 #000'
            }*/
                        //liturgytd.append(span);

                        let volumep = document.createElement('p');
            //liturgytd.append(volumep);
            volumep.innerHTML = 'Use the books of <b>Volume ' + romanize(metadata.volume) + '</b>.'

            if (metadata.note != undefined) {
                let notesp = document.createElement('p')
                notesp.innerHTML = '<b>Notes. </b> ' + metadata.note;
                if (hour !='Vespers') liturgytd.append(notesp)
            }

            if (metadata.vnote != undefined && hour == 'Vespers') {
                let notesp = document.createElement('p')
                notesp.innerHTML = '<b>Notes. </b> ' + metadata.vnote;
                liturgytd.append(notesp)
            }


            /*let penancep = document.createElement('p');
            liturgytd.append(penancep)
            switch (metadata.penance) {
            case 'fast': {
                penancep.innerHTML = '<b>Fasting. </b>';
                if (hour != 'Vespers') {
                    penancep.innerHTML += 'Mass follows  Sext.<br/>Dinner is taken after None.<br/>';
                } 
                
                if (!separate || hour == 'Vespers') {penancep.innerHTML += "Supper is not taken after Vespers."}
                break;
            }
            case 'abstinence': {
                penancep.innerHTML = '<b>Abstinence. </b>'
                if (hour != 'Vespers') {
                    penancep.innerHTML += 'Mass follows Terce.<br/>Dinner is taken after Sext.<br/>'
                }

                if (!separate || hour=='Vespers') {
                    //penancep.innerHTML += 'Supper with abstinence is taken after Vespers.';
                    let m2 = queryTMeta(hours['Vigils'].liturgy);
                    if (m2.penance == 'vigil') {
                        penancep.innerHTML += 'Dinner is taken after Vespers.'
                    } else {
                        penancep.innerHTML += 'Supper is taken after Vespers.' // supper by default is a meal of absistence
                    }
                }
                break;
            }
            case 'vigil': {
                // vigils can never be separated
                penancep.innerHTML = '<b>Vigil.</b> Mass follows None.'; 
                if (!separate) {
                    penancep.innerHTML += '<br/>Dinner is taken after Vespers.'
                }
                break;
            }
            default: {
                    // we know the day after a vigil has no penance
                    //penancep.innerHTML = '<b>No penance.</b> Mass follows the hour of Terce.<br/>Dinner is taken after Sext.' + ((separate && hour!='Vespers') ? '' : '<br/>Supper is taken after Vespers.')
                    penancep.innerHTML = '<b>No penance.</b> ';
                    if (hour != 'Vespers') {
                        penancep.innerHTML += 'Mass follows Terce.<br/>Dinner is taken after Sext.<br/>'
                    }

                    if (!separate || hour == 'Vespers') {
                        //penancep.innerHTML += 'Supper is taken after Vespers.'
                        let m2 = queryTMeta(hours['Vigils'].liturgy);
                        if (m2.penance == 'vigil') {
                            // day preceding was a vigil
                            penancep.innerHTML += 'Dinner is taken after Vespers.'
                        } else {
                            penancep.innerHTML += 'Supper is taken after Vespers.'
                        }
                    }
                }
            }

            span.innerHTML = metadata.name
            if (separate) {
                if (hour == 'Vigils') {
                    liturgytd.rowSpan = 6;
                    //tr.append(liturgytd)
                } else if (hour == 'Vespers') {
                    liturgytd.rowSpan = 2;
                    //tr.append(liturgytd)
                }
            } else {
                if (hour == 'Vigils') {
                    liturgytd.rowSpan = 8;
                    //tr.append(liturgytd)
                }
            }*/
            table.append(tr);
        }
        return table;
    }

    function advdat(dat, n = 1) {
        // advance date by one
        dat.setDate(dat.getDate() + n);
        return dat;
    }

    function treatAsUTC(date) {
        var result = new Date(date);
        result.setMinutes(result.getMinutes() - result.getTimezoneOffset());
        return result;
    }

    function daysBetween(startDate, endDate) {
        var millisecondsPerDay = 24 * 60 * 60 * 1000;
        return (treatAsUTC(endDate) - treatAsUTC(startDate)) / millisecondsPerDay;
    }

    function keyDate(date) {
        var now = date;
        var start = new Date(now.getFullYear(), 0, 0);
        return Math.floor(daysBetween(start, now));
    }

    function ordinal_suffix_of(i) {
        var j = i % 10,
            k = i % 100;
        if (j == 1 && k != 11) {
            return i + "st";
        }
        if (j == 2 && k != 12) {
            return i + "nd";
        }
        if (j == 3 && k != 13) {
            return i + "rd";
        }
        return i + "th";
    }

    function feriaToDay(n) {
            switch (n) {
            case 0: return 'sunday'
            case 1: return 'monday'
            case 2: return 'tuesday'
            case 3: return 'wednesday'
            case 4: return 'thursday'
            case 5: return 'friday'
            case 6: return 'saturday'
            }
        }

    function getTemporalMetaData() {
        var metadata = {
            'advent': {},
            'christmas': {},
            'epiphany': {},
            'prelent': {},
            'lent': {},
            'passion': {},
            'pascha': {},
            'ascension': {},
            'pentecost': {},
            'august': {},
            'september': {},
            'october': {},
            'november': {}
        };

        for (var w = 1; w < 5; w++) {
            metadata.advent[w] = {};
            metadata.advent[w].sunday = {
                name: ordinal_suffix_of(w) + ' Sunday of Advent',
                color: (w == 3) ? 'rose' : 'violet',
                rank: 2
            }

            for (var d = 1; d < 7; d++) {
                metadata.advent[w][feriaToDay(d)] = {
                    name: feriaToDay(d).charAt(0).toUpperCase() + feriaToDay(d).slice(1) + ' in the ' + ordinal_suffix_of(w) + ' Week of Advent',
                    color: 'violet',
                    penance: (d == 3 || d == 5) ? 'fast' : 'none',
                    rank: 8
                }
            }
        }

        metadata.christmas['vigil'] = {
            name: 'Eve of the Nativity of the Lord',
            rank: 8, // technically, it is a feria
            color: 'violet',
            penance: 'vigil'
        }

        metadata.christmas['vigil-sunday'] = {
            name: 'Eve of the Nativity on Sunday',
            rank: 2,
            color: 'violet',
            note: 'The Mass of the Fourth Sunday of Advent is sung after Terce. That of the eve is sung after None. The whole office is of the eve. Penance is abrogated by the Sunday.',
            //vnote: 'Vespers and Compline as on the Fourth Sunday of Advent.'
            ribbons: metadata.advent[4].sunday
        }

        metadata.epiphany['vigil-sunday'] = {
            name: 'Eve of the Epiphany on Sunday',
            rank: 8,
            color: 'violet',
            note: 'First Vespers superseded by Octave of the Innocents. Mass of Christmastide feria is sung after Terce. That of the eve is sung after None. The whole office is of the eve. Penance is abrogated by the Sunday.'
        }

        metadata.christmas['octave'] = {}
        metadata.christmas['octave'][1] = {
            name: 'Nativity of the Lord',
            rank: 1,
            color: 'white',
            note: 'Three Masses are said of the Nativity: one after Vigils, one after Lauds, and one after Terce.'
        }

        metadata.christmas.octave[2] = {
            name: 'Saint Stephen, Protomartyr',
            rank: 3,
            color: 'red'
        }

        metadata.christmas.octave[3] = {
            name: 'Saint John, Apostle and Evangelist',
            rank: 3,
            color: 'white'
        }

        metadata.christmas.octave[4] = {
            name: 'Holy Innocents, Martyrs',
            rank: 3,
            color: 'violet'
        }

        metadata.christmas.octave[5] = {
            name: 'Saint Thomas Becket, Bishop and Martyr',
            rank: 3,
            color: 'red'
        }

        metadata.christmas.octave[6] = {
            name: 'Sixth Day of the Nativity',
            rank: 8,
            color: 'white'
        }

        metadata.christmas.octave[7] = {
            name: 'Seventh Day of the Nativity',
            rank: 8,
            color: 'white'
        }

        metadata.christmas.octave[8] = {
            name: 'Circumcision of the Lord',
            rank: 1,
            color: 'white'
        }

        metadata.christmas.octave[9] = {
            name: 'Octave of Saint Stephen',
            rank: 8,
            color: 'red'
        }

        metadata.christmas.octave[10] = {
            name: 'Octave of Saint John',
            rank: 8,
            color: 'white'
        }

        metadata.christmas.octave[12] = {
            name: 'Octave of the Innocents',
            rank: 8,
            color: 'red'
        }

        metadata.epiphany.vigil = {
            name: 'Eve of the Epiphany',
            rank: 8,
            color: 'violet',
            penance: 'vigil'
        }

        metadata.epiphany.octave = {}
        metadata.epiphany.octave[1] = {
            name: 'Epiphany of the Lord',
            rank: 1,
            color: 'white'
        }

        for (var d = 1; d < 8; d++) {
            metadata.epiphany.octave[d + 1] = {
                name: ordinal_suffix_of(d + 1) + ' Day of the Epiphany',
                rank: 8, 
                color: 'white'
            }
        }

        metadata.epiphany.octave[8] = {
            name: 'Octave of the Epiphany',
            rank: 3,
            color: 'white'
        }

        metadata.christmas.feria = {}
        for (var d = 1; d <= 6; d++) {
            metadata.christmas.feria[d] = {
                name: feriaToDay(d).charAt(0).toUpperCase() + feriaToDay(d).slice(1) + ' in Christmastide',
                 rank: 8,
                 color: 'white',
                 penance: (d == 3 || d == 5) ? 'abstinence' : 'none'
             }
        }

        for (var w = 1; w <= 6; w++) {
            metadata.epiphany[w] = {}
            metadata.epiphany[w].sunday = {
                name: ordinal_suffix_of(w) + ' Sunday after Epiphany',
                rank: 4,
                color: 'green'
            }

            for (var d = 1; d < 7; d++) {
                metadata.epiphany[w][feriaToDay(d)] = {
                    name: feriaToDay(d).charAt(0).toUpperCase() + feriaToDay(d).slice(1) + ' in the ' + ordinal_suffix_of(w) + ' Week after Epiphany',
                    color: 'green',
                    penance: (d == 3 || d == 5) ? 'abstinence' : 'none',
                    rank: 8
                }
            }
        }

        metadata.epiphany.octave.sunday = {
            name: 'Sunday after Epiphany',
            rank: 4,
            color: 'white'
        }

        for (var w = 3; w > 0; w-- ) {
            metadata.prelent[w] = {}
            metadata.prelent[w].sunday = {
                name: ordinal_suffix_of(w) + ' Sunday before Lent',
                color: 'violet',
                rank: 2
            }

            for (var d = 1; d < 7; d++) {
                metadata.prelent[w][feriaToDay(d)] = {
                    name: feriaToDay(d).charAt(0).toUpperCase() + feriaToDay(d).slice(1) + ' in the ' + ordinal_suffix_of(w) + ' Week before Lent',
                    color: 'violet',
                    penance: (d == 3 || d == 5) ? 'fast' : 'none',
                    rank: 8
                }
            }
        }

        metadata.prelent[1].wednesday = {
            name: 'Ash Wednesday',
            color: 'violet',
            penance: 'strict-fast',
            rank: 7
        }

        metadata.prelent[1].thursday = {
            name: 'Thursday after Ashes',
            color: 'violet',
            penance: 'fast',
            rank: 8
        }

        metadata.prelent[1].friday = {
            name: 'Friday after Ashes',
            color: 'violet',
            penance: 'strict-fast',
            rank: 8
        }

        metadata.prelent[1].saturday = {
            name: 'Saturday after Ashes',
            color: 'violet',
            penance: 'fast',
            rank: 8
        }

        for (var w = 1; w < 5; w++) {
            metadata.lent[w] = {}
            metadata.lent[w].sunday = {
                name: ordinal_suffix_of(w) + ' Sunday in Lent',
                color: (w == 4) ? 'rose' : 'violet',
                penance: (w == 4) ? 'none' : 'abstinence',
                rank: 2
            }

            for (var d = 1; d < 7; d++) {
                metadata.lent[w][feriaToDay(d)] = {
                    name: feriaToDay(d).charAt(0).toUpperCase() + feriaToDay(d).slice(1) + ' in the ' + ordinal_suffix_of(w) + ' Week of Lent',
                    color: 'violet',
                    penance: (d==3 || d==5) ? 'strict-fast' : 'fast',
                    rank: 8
                }
            }
        }

        metadata.passion = {}
        metadata.passion[1] = {}
        metadata.passion[1].sunday = {
            name: '1st Sunday of the Passion',
            color: 'violet',
            penance: 'abstinence',
            rank: 2
        }

        for (var d = 1; d < 7; d++) {
            metadata.passion[1][feriaToDay(d)] = {
                name: feriaToDay(d).charAt(0).toUpperCase() + feriaToDay(d).slice(1) + ' in the First Week of Passiontide',
                color: 'violet',
                penance: 'strict-fast',
                rank: 8
            }
        }

        metadata.passion[2] = {}
        metadata.passion[2].sunday = {
            name: 'Palm Sunday',
            color: 'violet',
            penance: 'abstinence',
            rank: 2
        }

        metadata.passion[2].monday = {
            name: 'Monday in Holy Week',
            color: 'violet',
            penance: 'strict-fast',
            rank: 8
        }

        metadata.passion[2].tuesday = {
            name: 'Tuesday in Holy Week',
            color: 'violet',
            penance: 'strict-fast',
            rank: 8
        }

        metadata.passion[2].wednesday = {
            name: 'Wednesday in Holy Week',
            color: 'violet',
            penance: 'strict-fast',
            rank: 8
        }

        metadata.passion[2].thursday = {
            name: "Thursday of the Lord's Supper",
            color: 'violet',
            note: 'Liturgical color of the Mass is white.',
            penance: 'vigil',
            rank: 8
        }

        metadata.passion[2].friday = {
            name: 'Friday of the Preparation',
            color: 'black',
            penance: 'vigil',
            rank: 8
        }

        metadata.passion[2].saturday = {
            name: 'Holy Saturday',
            color: 'violet',
            note: 'Mass begins at the prescribed time for Vespers.<br/>Liturgical color changes to white at the Litany.',
            penance: 'vigil',
            rank: 8
        }

        metadata.pascha[1] = {}
        metadata.pascha[1].sunday = {
            name: 'Sunday of the Holy Pascha',
            color: 'white',
            rank: 0
        }

        for (var d = 1; d < 7; d++) {
            metadata.pascha[1][feriaToDay(d)] = {
                name: feriaToDay(d).charAt(0).toUpperCase() + feriaToDay(d).slice(1) + ' after Pascha',
                color: 'white',
                rank: 8
            }
        }

        for (var w = 2; w <= 6; w++) {
            metadata.pascha[w] = {}
            metadata.pascha[w].sunday = {
                name: ordinal_suffix_of(w - 1) + ' Sunday after Pascha',
                color: 'white',
                rank: 2
            }

            for (var d = 1; d < 7; d++) {
                metadata.pascha[w][feriaToDay(d)] = {
                    name: feriaToDay(d).charAt(0).toUpperCase() + feriaToDay(d).slice(1) + ' in the ' + ordinal_suffix_of(w - 1) + ' Week after Pascha',
                    color: 'white',
                    penance: (d == 3 || d == 5) ? 'abstinence' : 'none',
                    rank: 8
                }
            }
        }

        metadata.ascension.vigil = {
            name: 'Eve of the Ascension',
            color: 'violet',
            penance: 'vigil',
            rank: 8
        }

        metadata.ascension.octave = {}
        metadata.ascension.octave[1] = {
            name: 'Ascension of the Lord',
            color: 'white',
            rank: 1
        }

        for (var d = 2; d <= 8; d++) {
            metadata.ascension.octave[d] = {
                name: (d == 8) ? 'Octave of the Asecnsion' : ordinal_suffix_of(d) + ' Day of the Ascension',
                color: 'white',
                rank: 7
            }
        }

        metadata.ascension.octave[4].name = 'Sunday after Ascension'
        metadata.ascension.octave[4].rank = 2

        metadata.ascension.octave[8].rank = 3

        metadata.ascension.feria = {
            name: 'Friday in Ascensiontide',
            color: 'white',
            penance: 'abstinence',
            rank: 8
        }

        metadata.pentecost.vigil = {
            name: 'Eve of Pentecost',
            color: 'white',
            note: 'Liturgical color is white until None, violet until the introit of the Mass, and red thereafter.',
            penance: 'vigil',
            rank: 8
        }

        metadata.pentecost[0] = {
            sunday: {
                name: 'Sunday of Pentecost',
                rank: 2,
                color: 'red'
            },
            monday: {
                name: 'Monday of Pentecost',
                rank: 8,
                color: 'red'
            },
            tuesday: {
                name: 'Tuesday of Pentecost',
                rank: 8,
                color: 'red'
            },
            wednesday: {
                name: 'Ember Wednesday of Pentecost',
                rank: 7,
                color: 'red',
                penance: 'strict-fast',
            },
            thursday: {
                name: 'Thursday of Pentecost',
                rank: 8,
                color: 'red'
            },
            friday: {
                name: 'Ember Friday of Pentecost',
                rank: 7,
                color: 'red',
                penance: 'strict-fast'
            },
            saturday: {
                name: 'Ember Saturday of Pentecost',
                rank: 7,
                color: 'red',
                penance: 'vigil'
            }
        }

        for (var w = 1; w <= 28; w++) {
            metadata.pentecost[w] = {
                sunday: {
                    name: ordinal_suffix_of(w) + ' Sunday after Pentecost',
                    rank: 4,
                    color: 'green'
                }
            }

            for (var d = 1; d < 7; d++) {
                metadata.pentecost[w][feriaToDay(d)] = {
                    name: feriaToDay(d).charAt(0).toUpperCase() + feriaToDay(d).slice(1) + ' in the ' + ordinal_suffix_of(w) + ' Week after Pentecost',
                    rank: 8,
                    color: 'green',
                    penance: (d == 5) ? 'abstinence' : ''
                }
            }
        }

        var months = ['august', 'september', 'october', 'november'];
        for (var mnum in months) {
            var m = months[mnum]
            var name = m.charAt(0).toUpperCase() + m.slice(1)
            for (var w = 1; w <= 28; w++) {
                metadata[m][w] = {
                    sunday: {
                        name: ordinal_suffix_of(w) + ' Sunday of ' + name,
                        color: 'green',
                        rank: 4
                    }
                }

                for (var d = 1; d < 7; d++) {
                    metadata[m][w][feriaToDay(d)] = {
                        name: feriaToDay(d).charAt(0).toUpperCase() + feriaToDay(d).slice(1) + ' in the ' + ordinal_suffix_of(w) + ' Week of ' + name,
                        color: 'green',
                        rank: 8
                    }
                }
            }
        }

        /*metadata.pentecost[28].sunday.name = 'Sunday before Advent'
        for (var d = 1; d < 7; d++) {
            metadata.pentecost[28][feriaToDay(d)].name = feriaToDay(d).charAt(0).toUpperCase() + feriaToDay(d).slice(1) + ' in the Week before Advent'
        }*/


        metadata.advent[3].wednesday.name = 'Ember Wednesday of Advent'
        metadata.advent[3].wednesday.rank = 7
        metadata.advent[3].wednesday.penance = 'strict-fast'
        metadata.advent[3].friday.name = 'Ember Friday of Advent'
        metadata.advent[3].friday.rank = 7
        metadata.advent[3].friday.penance = 'strict-fast'
        metadata.advent[3].saturday.name = 'Ember Saturday of Advent'
        metadata.advent[3].saturday.rank = 7
        metadata.advent[3].saturday.penance = 'vigil'

        metadata.lent[1].wednesday.name = 'Ember Wednesday of Lent'
        metadata.lent[1].wednesday.penance = 'strict-fast'
        metadata.lent[1].wednesday.rank = 7
        metadata.lent[1].friday.name = 'Ember Friday of Lent'
        metadata.lent[1].friday.penance = 'strict-fast'
        metadata.lent[1].friday.rank = 7
        metadata.lent[1].saturday.name = 'Ember Saturday of Lent'
        metadata.lent[1].saturday.penance = 'vigil'
        metadata.lent[1].saturday.rank = 7

        // pentecost embertide is handled at its octave

        metadata.september[3].wednesday.name = 'Ember Wednesday of September'
            metadata.september[3].wednesday.penance = 'strict-fast'
            metadata.september[3].wednesday.color = 'violet'
            metadata.september[3].wednesday.rank = 7
        metadata.september[3].friday.name = 'Ember Friday of September'
            metadata.september[3].friday.penance = 'strict-fast'
            metadata.september[3].friday.color = 'violet'
            metadata.september[3].friday.rank = 7
        metadata.september[3].saturday.name = 'Ember Saturday of September'
            metadata.september[3].saturday.penance = 'vigil'
            metadata.september[3].saturday.color = 'violet'
            metadata.september[3].saturday.rank = 7

        for (var w in metadata.advent) {
            for (var d in metadata.advent[w]) {
                metadata.advent[w][d].volume = 1
            }
        }

        return metadata;
    }

    function getSanctoralMetaData() {
        return {
            'january': {
                '10': {
                    name: 'Saint Paul, Hermit',
                    color: 'white',
                    rank: 6
                },
                '17': {
                    name: 'Saint Anthony, Abbot',
                    color: 'white',
                    rank: 6
                },
                '21': {
                    name: 'Saint Agnes, Virgin-Martyr',
                    color: 'rose',
                    rank: 5
                },
                '24': {
                    name: 'Saint Timothy, Bishop and Martyr',
                    color: 'red',
                    rank: 6
                },
                '25': {
                    name: 'Conversion of Saint Paul, Apostle',
                    color: 'white',
                    rank: 3
                },
                '30': {
                    name: 'Saint Gregory Nazianzus, Bishop and Doctor',
                    color: 'white',
                    rank: 5
                }
            },
            'february': {
                '2': {
                    name: 'Purification of the Blessed Virgin Mary',
                    color: 'blue',
                    rank: 1,
                    penance: 'none',
                    note: 'Liturgical color of the procession is violet.'
                },
                '3': {
                    name: 'Saint Blase, Bishop and Martyr',
                    color: 'red',
                    rank: 6
                },
                '5': {
                    name: 'Saint Agatha, Virgin-Martyr',
                    color: 'rose',
                    rank: 5
                },
                '10': {
                    name: 'Saint Scholastica, Virgin',
                    color: 'white',
                    rank: 6
                },
                '14': {
                    name: 'Saint Valentine, Priest and Martyr',
                    color: 'red',
                    rank: 6
                }
            },
            'march': {
                '7': {
                    name: 'Saints Perpetua and Felicity, Martyrs',
                    color: 'red',
                    rank: 6
                },
                '12': {
                    name: 'Saint Gregory, Pope and Doctor',
                    color: 'white',
                    rank: 5
                },
                '17': {
                    name: 'Saint Patrick, Bishop',
                    color: 'white',
                    rank: 6
                },
                '21': {
                    name: 'Saint Benedict, Abbot',
                    color: 'white',
                    rank: 5
                },
                '25': {
                    name: 'Annunciation of the Blessed Virgin Mary',
                    rank: 3,
                    color: 'blue'
                },
            },
            'april': {
                '14': {
                    name: 'Saint Justin, Martyr',
                    color: 'red',
                    rank: 6
                },
                '23': {
                    name: 'Saint George, Martyr',
                    color: 'red',
                    rank: 6
                },
                '25': {
                    name: 'Saint Mark, Evangelist',
                    color: 'red',
                    rank: 3
                },
                '26': {
                    name: 'Saint Cletus, Pope and Martyr',
                    color: 'red',
                    rank: 6
                },
                '30': {
                    name: 'Eve of Saints Philip and James',
                    color: 'violet',
                    rank: 8,
                    penance: 'vigil'
                },
            },
            'may': {
                '1': {
                    name: 'Saints Philip and James, Apostles',
                    color: 'red',
                    rank: 3
                },
                '2': {
                    name: 'Saint Athanasius, Bishop and Doctor',
                    color: 'white',
                    rank: 6
                },
                '3': {
                    name: 'Saint Alexander, Pope and Martyr',
                    color: 'red',
                    rank: 6
                },
                '6': {
                    name: 'Saint John, Apostle, before the Latin Gate',
                    color: 'red',
                    rank: 3
                },
                '14': {
                    name: 'Saint Matthias, Apostle',
                    color: 'red',
                    rank: 3
                },
                '25': {
                    name: 'Saint Bede, Priest and Doctor',
                    color: 'white',
                    rank: 6
                },
                '31': {
                    name: 'Visitation of the Blessed Virgin Mary',
                    color: 'blue',
                    rank: 1,
                    penance: 'none'
                }
            },
            'june': {
                '2': {
                    name: 'Saints Marcellinus and Peter, Martyrs',
                    color: 'red',
                    rank: 6
                },
                '11': {
                    name: 'Saint Barnabas, Apostle',
                    color: 'red',
                    rank: 5
                },
                '14': {
                    name: 'Saint Basil of Caesarea, Bishop and Doctor',
                    color: 'white',
                    rank: 5
                },
                '18': {
                    name: 'Dedication of Holy Trinity Church',
                    color: 'white',
                    rank: 1,
                    penance: 'none'
                },
                '23': {
                    name: 'Eve of Saint John Baptist',
                    color: 'violet',
                    rank: 8,
                    penance: 'vigil'
                },
                '24': {
                    name: 'Nativity of Saint John Baptist',
                    color: 'white',
                    rank: 3
                },
                '26': {
                    name: 'Saints John and Paul, Martyrs',
                    color: 'red',
                    rank: 6
                },
                '28': {
                    name: 'Eve of Saints Peter and Paul',
                    rank: 8,
                    color: 'violet',
                    penance: 'vigil'
                },
                '29': {
                    name: 'Saints Peter and Paul, Apostles',
                    color: 'red',
                    rank: 3
                },
                '30': {
                    name: 'Synaxis of Saint Paul, Apostle',
                    color: 'red',
                    rank: 3
                }
            },
            'july': {
                '2': {
                    name: 'Eve of Saint Thomas',
                    color: 'violet',
                    rank: 8,
                    penance: 'vigil'
                },
                '3': {
                    name: 'Saint Thomas, Apostle',
                    color: 'red',
                    rank: 3
                },
                '22': {
                    name: 'Saint Mary Magdalene',
                    color: 'white',
                    rank: 5
                },
                '24': {
                    name: 'Eve of Saint James',
                    color: 'violet',
                    rank: 8,
                    penance: 'vigil'
                },
                '25': {
                    name: 'Saint James the Greater, Apostle',
                    color: 'red',
                    rank: 3
                },
                '27': {
                    name: 'Saint Pantaleon, Martyr',
                    color: 'red',
                    rank: 6
                }
            },
            'august': {
                '6': {
                    name: 'Transfiguration of the Lord',
                    color: 'white',
                    rank: 3
                },
                '7': {
                    name: 'Saint Sixtus, Pope and Martyr',
                    color: 'red',
                    rank: 6
                },
                '10': {
                    name: 'Saint Laurence, Deacon and Martyr',
                    color: 'red',
                    rank: 5
                },
                '14': {
                    name: 'Eve of the Assumption',
                    color: 'violet',
                    rank: 8,
                    penance: 'vigil'
                },
                '15': {
                    name: 'Assumption of the Blessed Virgin Mary',
                    color: 'blue',
                    rank: 1,
                    penance: 'none'
                },
                '23': {
                    name: 'Eve of Saint Bartholomew',
                    color: 'violet',
                    rank: 8,
                    penance: 'vigil'
                },
                '24': {
                    name: 'Saint Bartholomew, Apostle',
                    color: 'red',
                    rank: 3
                },
                '28': {
                    name: 'Saint Augustine of Hippo, Bishop and Doctor',
                    color: 'white',
                    rank: 5
                },
                '29': {
                    name: 'Beheading of Saint John Baptist',
                    color: 'red',
                    rank: 5
                }
            },
            'september': {
                '8': {
                    name: 'Nativity of the Blessed Virgin Mary',
                    color: 'blue',
                    rank: 1,
                    penance: 'none'
                },
                '13': {
                    name: 'Saint John Chrysostom, Bishop and Doctor',
                    color: 'white',
                    rank: 5
                },
                '14': {
                    name: 'Exaltation of the Holy Cross',
                    color: 'red',
                    rank: 3
                },
                '16': {
                    name: 'Saints Cornelius and Cyprian, Bishops and Martyrs',
                    color: 'red',
                    rank: 6
                },
                '20': {
                    name: 'Eve of Saint Matthew',
                    color: 'violet',
                    rank: 8,
                    penance: 'vigil'
                },
                '21': {
                    name: 'Saint Matthew, Apostle and Evangelist',
                    color: 'red',
                    rank: 3
                },
                '23': {
                    name: 'Saint Linus, Pope and Martyr',
                    color: 'red',
                    rank: 6
                },
                '26': {
                    name: 'Saints Cosmas and Damian, Martyrs',
                    color: 'red',
                    rank: 6
                },
                '28': {
                    name: 'Saint Anastasia, Virgin-Martyr',
                    color: 'rose',
                    rank: 6
                },
                '29': {
                    name: 'Saint Michael, Archangel',
                    color: 'white',
                    rank: 3
                },
                '30': {
                    name: 'Saint Jerome, Priest and Doctor',
                    color: 'white',
                    rank: 5
                }
            },
            'october': {
                '2': {
                    name: 'Holy Guardian Angels',
                    color: 'white',
                    rank: 5
                },
                '17': {
                    name: 'Saint Ignatius of Antioch, Bishop and Martyr',
                    color: 'red',
                    rank: 6
                },
                '18': {
                    name: 'Saint Luke, Evangelist',
                    color: 'red',
                    rank: 3
                },
                '27': {
                    name: 'Eve of Saints Simon and Jude',
                    color: 'violet',
                    rank: 8,
                    penance: 'vigil'
                },
                '28': {
                    name: 'Saints Simon and Jude, Apostles',
                    color: 'red',
                    rank: 3
                },
                '31': {
                    name: 'Eve of the Communion',
                    color: 'violet',
                    rank: 8,
                    penance: 'vigil'
                }
            },
            'november': {
                '1': {
                    name: 'Communion of All Saints',
                    color: 'white',
                    rank: 1,
                    penance: 'none'
                },
                '2': {
                    name: 'Synaxis of the Holy Souls',
                    color: 'black',
                    rank: 8 // this also must be counted with feria
                },
                '11': {
                    name: 'Saint Martin, Confessor',
                    color: 'white',
                    rank: 6
                },
                '21': {
                    name: 'Presentation of the Blessed Virgin Mary',
                    color: 'blue',
                    rank: 5
                },
                '22': {
                    name: 'Saint Cecilia, Virgin-Martyr',
                    color: 'rose',
                    rank: 5
                },
                '23': {
                    name: 'Saint Clement, Pope and Martyr',
                    color: 'red',
                    rank: 5
                },
                '24': {
                    name: 'Saint Chrysogonus, Martyr',
                    color: 'red',
                    rank: 6
                },
                '25': {
                    name: 'Saint Catherine, Virgin-Martyr',
                    color: 'rose',
                    rank: 6
                },
                '29': {
                    name: 'Eve of Saint Andrew, Apostle',
                    color: 'violet',
                    penance: 'vigil',
                    rank: 8 // we will treat it as a feria
                },
                '30': {
                    name: 'Saint Andrew, Apostle',
                    color: 'red',
                    rank: 3
                }
            },
            'december': {
                '6': {
                    name: 'Saint Nicholas, Bishop and Confessor',
                    color: 'white',
                    rank: 5
                },
                '7': {
                    name: 'Saint Ambrose, Bishop and Doctor',
                    color: 'white',
                    rank: 5
                },
                '8': {
                    name: 'Conception of the Blessed Virgin Mary',
                    color: 'blue',
                    rank: 3
                },
                '13': {
                    name: 'Saint Lucy, Virgin-Martyr',
                    color: 'rose',
                    rank: 5
                }
            }
        }
    }

    tMeta = getTemporalMetaData();
    sMeta = getSanctoralMetaData();
    oMeta = {
        december: {
            '17': {
                name: 'O Wisdom'
            },
            '18': {
                name: 'O Adonay'
            },
            '19': {
                name: 'O Root of Jesse'
            },
            '20': {
                name: 'O Key of David'
            },
            '21': {
                name: 'O Dayspring'
            },
            '22': {
                name: 'O King of the Gentiles'
            },
            '23': {
                name: 'O Emmanuel'
            }
        }
    };
    function queryTMeta(calendar) {
        // convert calendar data  to its metadata
            var metadata = JSON.parse(JSON.stringify(tMeta));
            var id = calendar.id.split('/');
            for (var i = 0; i < id.length; i++) {
                var part = id[i]
                if (metadata[part] != undefined) {
                    metadata = metadata[part]
                }
            }

            if (calendar.oid != undefined) {
                var oidm = JSON.parse(JSON.stringify(oMeta));
                var id = calendar.oid.split('/');
                    for (var i = 0; i < id.length; i++) {
                    var part = id[i]
                        if (oidm[part] != undefined) {
                            oidm = oidm[part]
                        }
                    }
            }

            if (calendar.subid != undefined) {
                var om = JSON.parse(JSON.stringify(tMeta));
                var id = calendar.subid.split('/');
                    for (var i = 0; i < id.length; i++) {
                    var part = id[i]
                        if (om[part] != undefined) {
                            om = om[part]
                        }
                    }
            }

            if (calendar.stid != undefined) {
                var st = JSON.parse(JSON.stringify(sMeta));
                var id = calendar.stid.split('/');
                    for (var i = 0; i < id.length; i++) {
                    var part = id[i]
                        if (st[part] != undefined) {
                            st = st[part]
                        }
                    }
            }

            if (om != undefined) {
                if (om.rank < metadata.rank) {
                    // everything from subid
                    metadata = JSON.parse(JSON.stringify(om))
                } else if (om.rank == metadata.rank) {
                    // merge: om has priority
                    metadata.backup = JSON.parse(JSON.stringify(metadata))
                    metadata.backup.id = calendar.id
                    om.id = calendar.subid
                    mergeDeep(metadata, om)
                    var id = metadata.backup.id.split('/')
                    metadata.name = om.name + ' and ' + ordinal_suffix_of(id[1]) + ' after ' + id[0].charAt(0).toUpperCase() + id[0].slice(1)
                }

                // else, everything is taken from metadata
            }

            if (st != undefined) {
                /*metadata.backup = JSON.parse(JSON.stringify(metadata))
                if (st.rank > 5) {
                    // in this case, merging the two is necessary
                    mergeDeep(metadata, st); // st is given the priority
                } else if (st.rank < metadata.rank) {
                    metadata = st; // this can only be true if >simplex anyways
                } else if (st.rank == metadata.rank) {
                    // this ought only be vigil days
                    mergeDeep(metadata, st);
                }*/

                // if today is feria, always merge, unless strong feria
                if (metadata.rank == 8) {
                    mergeDeep(metadata, st);
                }

                // if the saint is ranked higher than the feria
                if (st.rank < metadata.rank) {
                    metadata = st;
                }
            }

            if (oidm != undefined) {
                metadata.note = oidm.name;
                mergeDeep(oidm, metadata);
            }
            

            switch (metadata.color) {
            case 'violet': metadata.color = '#4c0099'; break;
            case 'rose': metadata.color = '#fa48ad'; break;
            case 'blue': metadata.color = '#468FEA'; break;
            }

            if (metadata.penance === undefined) metadata.penance = 'none'
            return metadata
    }

    function getLiturgicalCalendar(year) {
        function gendat(m, d, y = year) {
            var n = new Date();
            n.setMonth(m - 1);
            n.setDate(d);
            n.setFullYear(y);
            return n;
        }

        var easterSunday = computus(year);
        var adventSunday = computus2(year);

        var calendar = {};

        console.log("In the year of Our Lord " + year)

        console.log("Easter is " + easterSunday.toDateString());
        console.log("Advent is " + adventSunday.toDateString());

        /* the sundays of paschaltide */

        var nxtSunday = new Date(easterSunday);

        for (var i = 0; i < 6; i++) {
            calendar[keyDate(nxtSunday)] = {
                //name: (i == 0) ? "Pascha" : ordinal_suffix_of(i) + " Sunday after Pascha",
                id: "pascha/" + (i + 1) + "/sunday",
                date: nxtSunday.toDateString(),
            };

            nxtSunday.setDate(nxtSunday.getDate() + 7);
        }

        /* days of the ascension octave */
        var ascension = new Date(nxtSunday);
        advdat(ascension, -3);
        for (i = 0; i < 8; i++) {
            if (i == 0) {
                calendar[keyDate(ascension)] = {
                    //name: 'Ascension of the Lord',
                    id: "ascension/octave/1",
                    date: ascension.toDateString(),
                };
            } else if (i == 7) {
                calendar[keyDate(ascension)] = {
                    //name: 'Octave of the Ascension',
                    id: "ascension/octave/8",
                    date: ascension.toDateString(),
                };
            } else {
                //if (calendar[keyDate(ascension)] === undefined) {
                calendar[keyDate(ascension)] = {
                    //name: ordinal_suffix_of(i) + ' Day after Ascension',
                    id: "ascension/octave/" + (i + 1),
                    date: ascension.toDateString(),
                };
                //}
            }

            advdat(ascension);
        }

        calendar[keyDate(ascension)] = {
            id: 'ascension/feria',
            date: ascension.toDateString()
        }

        /* pentecost sunday */

        calendar[keyDate(advdat(nxtSunday, 7))] = {
            //name: 'Pentecost',
            id: "pentecost/0/sunday",
            date: nxtSunday.toDateString(),
        };

        /* the sundays after pentecost */

        var seventhSunday;

        for (var i = 0; i < 24; i++) {
            advdat(nxtSunday, 7);
            if (i == 6) {
                seventhSunday = new Date(nxtSunday);
            }
            calendar[keyDate(nxtSunday)] = {
                //name: ordinal_suffix_of(i + 1) + ' Sunday after Pentecost',
                id: "pentecost/" + (i + 1) + "/sunday",
                date: nxtSunday.toDateString(),
            };
        }

        function subidSundays(date, n, id) {
            if (date.getDay() == 0) {
                advdat(date);
            }

            while (date.getDay() != 0) {
                advdat(date);
            }

            for (var i = 0; i < n; i++) {
                if (calendar[keyDate(date)].id.split("/")[0] != "pentecost" && calendar[keyDate(date)].id.split("/")[0] != "epiphany") {
                    //console.log(date.toDateString() + " would be " + id + '/' + (i + 1) + '/sunday')
                    //console.log("\tcannot be included in advent")
                } else {
                    calendar[keyDate(date)].subid = id + "/" + (i + 1) + "/sunday";
                }
                advdat(date, 7);
            }
        }

        function queryid(id) {
            for (var x in calendar) {
                if (calendar[x].id == id) return x;
            }
            return -1;
        }

        function querysubid(id) {
            for (var x in calendar) {
                if (calendar[x].subid == id) return x;
            }
            return -1;
        }

        // before we can add in the november dates, we must ensure we have continuous sundays from pentecost until advent
        // if there are sundays missing, we can add in the octaves of the Assumption and All Saints, in this ordrer
        // the octave-days will overwrite the sunday
        // the sunday will be deffered to the next sunday
        // now let's say we had this scheudle
        /**
         * Nth Sunday after Pentecost
         * Monday
         * Tuesday
         * Assumption (Wednesday)
         * 2nd (Thursday)
         * 3rd (Friday)
         * 4th (Saturday)
         * 5th (Sunday)
         * 6th (Monday)
         * 7th (Tuesday)
         * Octave (Wednesday)
         * */
        // The octave of the assumption repealed Wednesday->Saturday
        // so the days after the octave would be the Thursday, Friday, and Saturday offices removed; Wednesday is lost to the feast itself
        // thus, the Sunday is deferred to next week, and begins there, without losing any offices

        // now, so as to maintain a common calendar, the Assumption and All Saints will always have octaves, and these octaves will always defer the sunday within them to the next

        /* the four sundays of advent */

        nxtSunday = new Date(adventSunday);
        for (var i = 0; i < 4; i++) {
            calendar[keyDate(nxtSunday)] = {
                //name: ordinal_suffix_of(i + 1) + " Sunday of Advent",
                id: "advent/" + (i + 1) + "/sunday",
                date: nxtSunday.toDateString(),
            };
            advdat(nxtSunday, 7);
        }

        /* Sunday next before Advent */

        nxtSunday = advdat(new Date(adventSunday), -7);
        calendar[keyDate(nxtSunday)] = {
            //name: 'Sunday before Advent',
            id: "pentecost/28/sunday",
            date: nxtSunday.toDateString(),
        };

        // we must now fill in the missing sundays, up to 2
        {
            var i = 25;
            var epi = 4;
            while (calendar[keyDate(advdat(nxtSunday, -7))] === undefined) {
                // bring us to an undefined suday
            }

            while (calendar[keyDate(advdat(nxtSunday, 7))] === undefined) {
                calendar[keyDate(nxtSunday)] = {
                    id: "pentecost/" + i + "/sunday",
                    date: nxtSunday.toDateString(),
                    refid: "epiphany/" + epi + "/sunday",
                };
                i += 1;
                epi += 1;
            }
        }

        // we can now fill in the autumn sundays
        /* the sundays of wisdom */
        /* first sunday aftr the fifth kalends of august */
        /* which i understand to be the 28th of july */
        subidSundays(gendat(7, 28), 5, "august");
        /**
         * August I = Proverbs
         * August II = Ecclesiastes
         * August III = Wisdom
         * August IV = Sirach
         * August V = Sirach
         /* 

    /* the sundays of job */
        /* first sunday after the fifth kalends of septmber */
        subidSundays(gendat(8, 28), 5, "september");
        /**
         * September I = Job
         * September II = Job
         * Septemver III = Tobit (where i beleive falls the september embertide)
         * Septemver IV = Tobit (but if there only be 4 weeks, = Setpevmer V)
         * Septemver V = Judith
         * */

        subidSundays(gendat(9, 27), 5, "october");
        /**
         * October I = 1 Macchabbes
         * October II = 1 Maccabees
         * October III = 1 Maccabees
         * Octover IV = 2 Maccabees
         * October V = 2 Maccabess
         * */

        if (querysubid("september/5/sunday") == -1) {
            // apply above rubric
            var x = querysubid("september/4/sunday");
            calendar[x].subid = "september/5/sunday";
            calendar[x].transfers = {
                subid: true,
            };
        }

        subidSundays(gendat(10, 28), 5, "november");
        /**
         * November I = Ezekiel
         * November II = Ezekiel (but if 4 weeks = November III)
         * November III = Daniel (but if 4 weeks = November IV)
         * November IV = Hosea, Joel, Amos, Obadiah, Jonah (but if 4 weeks = Novermber V)
         * November V = Micah, Nahum, Habbakkuk, Zephaniah, Haggai, Zechariah, Malachi
         * */

        /* the two sundays of passiontide */

        nxtSunday = easterSunday;
        for (var i = 0; i < 2; i++) {
            calendar[keyDate(advdat(nxtSunday, -7))] = {
                //name: (i == 0) ? 'Palm Sunday' : 'Passion Sunday',
                id: "passion/" + (2 - i) + "/sunday",
                date: nxtSunday.toDateString(),
            };
        }

        /* the four sundays of lent */
        for (var i = 0; i < 4; i++) {
            calendar[keyDate(advdat(nxtSunday, -7))] = {
                //name: ordinal_suffix_of(4 - i) + ' Sunday in Lent',
                id: "lent/" + (4 - i) + "/sunday",
                date: nxtSunday.toDateString(),
            };
        }

        /* the three sundays before lent */
        for (var i = 0; i < 3; i++) {
            calendar[keyDate(advdat(nxtSunday, -7))] = {
                //name: ordinal_suffix_of(i + 1) + ' Sunday before Lent',
                id: "prelent/" + (i + 1) + "/sunday",
                date: nxtSunday.toDateString(),
            };
        }

        /* epiphany of the lord */
        var epiphany = gendat(1, 6); // jan 6
        for (var i = 0; i < 1; i++) {
            calendar[keyDate(epiphany)] = {
                //name: (i == 0) ? 'Epiphany of the Lord' : ordinal_suffix_of(i) + ' Day of the Epiphany',
                id: "epiphany/octave/" + (i + 1),
                date: epiphany.toDateString(),
            };

            if (epiphany.getDay() == 0 && i > 0) {
                calendar[keyDate(epiphany)].id = "epiphany/octave/sunday";
                nxtSunday = new Date(epiphany);
                ;
            }
            advdat(epiphany);
        }

        /* days until first sunday after octave of epiphany */

        {
            var i = 1;
            while (epiphany.getDay() != 0) {
                calendar[keyDate(epiphany)] = {
                    // name: ordinal_suffix_of(i) + ' Feria after Epiphanytide',
                    id: "christmas/feria/" + epiphany.getDay(),
                    date: epiphany.toDateString(),
                };
                i += 1;
                advdat(epiphany);
            }
        }

        nxtSunday = epiphany;

        /* the sundays after epiphny */
        {
            //advdat(nxtSunday, 7);
            var i = 1;
            while (calendar[keyDate(nxtSunday)] === undefined) {
                calendar[keyDate(nxtSunday)] = {
                    //name: ordinal_suffix_of(i + 1) + ' Sunday after Epihpany',
                    id: "epiphany/" + i + "/sunday",
                    date: nxtSunday.toDateString(),
                };
                advdat(nxtSunday, 7);
                i += 1;
            }
        }

        /* circumcision &c until epiphany */
        calendar[keyDate(gendat(1, 1))] = {
            //name: 'Circumcision of the Lord',
            id: "christmas/octave/8",
            date: gendat(1, 1).toDateString(),
        };

        calendar[keyDate(gendat(1, 2))] = {
            //name: 'Octave of Saint Stephen',
            id: "christmas/octave/9",
            date: gendat(1, 2).toDateString(),
        };

        calendar[keyDate(gendat(1, 3))] = {
            //name: 'Octave of Saint John',
            id: "christmas/octave/10",
            date: gendat(1, 3).toDateString(),
        };

        calendar[keyDate(gendat(1, 4))] = {
            //name: 'Octave of the Holy Innocents',
            id: "christmas/octave/12",
            date: gendat(1, 4).toDateString(),
        };

        calendar[keyDate(gendat(1, 5))] = {
            //name: 'Eve of the Epiphany',
            id: "epiphany/vigil",
            date: gendat(1, 5).toDateString(),
        };

        /* christmas &c */
        calendar[keyDate(gendat(12, 24))] = {
            // name: 'Eve of the Nativity',
            id: "christmas/vigil",
            date: gendat(12, 24).toDateString(),
        };

        if (gendat(12,24).getDay() == 0) {
            calendar[keyDate(gendat(12, 24))].id = 'christmas/vigil-sunday'
        }

        if (gendat(1,5).getDay() == 0) {
            calendar[keyDate(gendat(1, 5))].id = 'epiphany/vigil-sunday'
        }

        calendar[keyDate(gendat(12, 25))] = {
            //  name: 'Nativity of the Lord',
            id: "christmas/octave/1",
            date: gendat(12, 25).toDateString(),
        };

        calendar[keyDate(gendat(12, 26))] = {
            //name: 'Saint Stephen, Protomartyr',
            id: "christmas/octave/2",
            date: gendat(12, 26).toDateString(),
        };

        calendar[keyDate(gendat(12, 27))] = {
            //name: 'Saint John, Apostle and Evangelist',
            id: "christmas/octave/3",
            date: gendat(12, 27).toDateString(),
        };

        calendar[keyDate(gendat(12, 28))] = {
            //name: 'Holy Innocents, Martyrs',
            id: "christmas/octave/4",
            date: gendat(12, 28).toDateString(),
        };

        calendar[keyDate(gendat(12, 29))] = {
            //name: 'Saint Thomas Becket, Bishop and Martyr',
            id: "christmas/octave/5",
            date: gendat(12, 29).toDateString(),
        };

        calendar[keyDate(gendat(12, 30))] = {
            //name: 'Sixth Day of the Nativity',
            id: "christmas/octave/6",
            date: gendat(12, 30).toDateString(),
        };

        calendar[keyDate(gendat(12, 31))] = {
            // name: 'Seventh Day of the Nativity',
            id: "christmas/octave/7",
            date: gendat(12, 31).toDateString(),
        };

        if (querysubid("november/5/sunday") == -1) {
            var x = querysubid("november/2/sunday");
            calendar[x].subid = "november/3/sunday";
            calendar[x].transfers = {
                subid: true,
            };
            calendar[Number(x) + 7].subid = "november/4/sunday";
            calendar[Number(x) + 7].transfers = {
                subid: true,
            };
            calendar[Number(x) + 7 + 7].subid = "november/5/sunday";
            calendar[Number(x) + 7 + 7].transfers = {
                subid: true,
            };
        }

        {
            var x = queryid("pentecost/28/sunday");
            if (calendar[Number(x) - 7].id != "pentecost/27/sunday") {
                if (calendar[x].transfers === undefined) calendar[x].transfers = {};
                calendar[x].transfers.id = true;
            }
        }

        /* ascension eve */
        var x = queryid("ascension/octave/1");
        calendar[Number(x) - 1] = {
            id: "ascension/vigil",
            date: advdat(new Date(calendar[x].date), -1).toDateString(),
        };

        /* pentecost eve*/
        var x = queryid("pentecost/0/sunday");
        calendar[Number(x) - 1] = {
            id: "pentecost/vigil",
            date: advdat(new Date(calendar[x].date), -1).toDateString(),
        };

        // now we fill in with saints days
        // i see no better way than a manual insertation
        function sanc(date) {
            var id = date.toLocaleString('default', { month: 'long' }).toLowerCase() + '/' + date.getDate();
            if (calendar[keyDate(date)] == undefined) {
                calendar[keyDate(date)] = {
                    id: '',
                    stid: id,
                    date: date.toDateString(),
                }
            } else {
                calendar[keyDate(date)].stid = id;
            }
        }

        sanc(gendat(1, 10))
        sanc(gendat(1, 17))
        sanc(gendat(1, 21))
        //sanc(gendat(1, 24))
        sanc(gendat(1, 25))
        //sanc(gendat(1, 30))
        //sanc(gendat(2, 1))
        sanc(gendat(2, 2))
        //sanc(gendat(2, 3))
        sanc(gendat(2, 5))
        //sanc(gendat(2, 10))
        sanc(gendat(2, 14))
        //sanc(gendat(3, 7))
        //sanc(gendat(3, 12))
        //sanc(gendat(3, 17))
        sanc(gendat(3, 21))
        sanc(gendat(3, 25))
        //sanc(gendat(4, 14))
        sanc(gendat(4, 23))
        sanc(gendat(4, 25))
        //sanc(gendat(4, 26))
        sanc(gendat(4, 30))
        sanc(gendat(5, 1))
        //sanc(gendat(5, 2))
        sanc(gendat(5, 3))
        //sanc(gendat(5, 6))
        sanc(gendat(5, 14))
        sanc(gendat(5, 31))
        sanc(gendat(6, 2))
        sanc(gendat(6, 11))
        //sanc(gendat(6, 14))
        sanc(gendat(6, 18)) // dedication of holy trinity
        sanc(gendat(6, 23))
        sanc(gendat(6, 24))
        sanc(gendat(6, 26))
        sanc(gendat(6, 28))
        sanc(gendat(6, 29))
        sanc(gendat(6, 30))
        sanc(gendat(7, 2))
        sanc(gendat(7, 3))
        sanc(gendat(7, 22))
        sanc(gendat(7, 24))
        sanc(gendat(7, 25))
        sanc(gendat(7, 27))
        sanc(gendat(8, 6))
        sanc(gendat(8, 7))
        sanc(gendat(8, 10))
        sanc(gendat(8, 14))
        sanc(gendat(8, 15))
        sanc(gendat(8, 23))
        sanc(gendat(8, 24))
        //sanc(gendat(8, 28))
        sanc(gendat(8, 29))
        sanc(gendat(9, 8))
        //sanc(gendat(9, 13))
        sanc(gendat(9, 14))
        sanc(gendat(9, 16))
        sanc(gendat(9, 20))
        sanc(gendat(9, 21))
        sanc(gendat(9, 23))
        sanc(gendat(9, 26))
        sanc(gendat(9, 28))
        sanc(gendat(9, 29))
        //sanc(gendat(9, 30))
        //sanc(gendat(10, 2))
        sanc(gendat(10, 17))
        sanc(gendat(10, 18))
        sanc(gendat(10, 27))
        sanc(gendat(10, 28))
        sanc(gendat(10, 31))
        sanc(gendat(11, 1))
        sanc(gendat(11, 2))
        sanc(gendat(11, 11))
        //sanc(gendat(11, 21))
        sanc(gendat(11, 22))
        sanc(gendat(11, 23))
        sanc(gendat(11, 24))
        //sanc(gendat(11, 25))
        sanc(gendat(11, 29))
        sanc(gendat(11, 30))
        sanc(gendat(12, 6))
        //sanc(gendat(12, 7))
        sanc(gendat(12, 8))
        sanc(gendat(12, 13))

        // we can now fill in the feria
        
        function prevSunday(n) {
            // get the previous sunday from a index on the calendar
            // note that this doesn't look at sundays, but at days of the form '[season]/[week]/sunday'
            while (calendar[n] === undefined) {
                if (n <= 0) {
                    return -1
                }
                n -= 1
            }

            var id = calendar[n].id.split('/');
            if (id.length < 3) {
                return prevSunday(n - 1)
            }

            if (id[2] != 'sunday') {
                return prevSunday(n- 1)
            }

            return n
        }

        for (var i = 1; i <= queryid('christmas/octave/7'); i++) {
            var prev = prevSunday(i);
            if (prev == -1) {
                continue;
            };
            if (calendar[i] === undefined || calendar[i].id == '') {
                var thisdate = new Date(calendar[prev].date);
                var previd = calendar[prev].id.split('/')
               for (var n = 1; n < 7; n++) {
                    var x =keyDate(advdat(thisdate))
                    if (calendar[x] != undefined) {
                        if (calendar[x].id != '') {continue}
                            else {
                                calendar[x].id = previd[0] + '/' + previd[1] + '/' + feriaToDay(n);
                                calendar[x].transfers = calendar[prev].transfers;
                                continue;
                            }
                    }
                    calendar[x] = {
                        id: previd[0] + '/' + previd[1] + '/' + feriaToDay(n),
                        date: thisdate.toDateString(),
                    }
                    if (calendar[prev].transfers != undefined) {
                        calendar[x].transfers = calendar[prev].transfers
                    }
               }
            }
        }

        // now do the same for the sundays of august &c
        for (var i = querysubid('august/1/sunday'); i < queryid('advent/1/sunday'); i++) {
            var prev = prevSunday(i);
            if (prev == -1) continue;
            if (calendar[i].subid === undefined) {
                var thisdate = new Date(calendar[prev].date);
                var previd = calendar[prev].subid.split('/')
                for (var n = 1; n < 7; n++) {
                    var x = keyDate(advdat(thisdate))
                    if (calendar[x].subid != undefined) continue;
                    calendar[x].subid = previd[0] + '/' + previd[1] + '/' + feriaToDay(n)
                }
            }
        }

        /* o antiphons */
        /*var dec17 = gendat(12, 17)
        for (var i = 0; i < 7; i++) {
            calendar[keyDate(dec17)].subid = 'december/' + (i + 17)
            advdat(dec17)
        }*/

        // verify
        for (var i = 1; i <= queryid('christmas/octave/7'); i++) {
            if (calendar[i] === undefined) {
                alert("ERROR: calendar["+i+"] = undefined")
            }
        }

        for (var i = querysubid('august/1/sunday'); i < queryid('advent/1/sunday'); i++) {
            if (calendar[i].subid == undefined) {
                alert("ERROR: calendar["+i+"].subid = undefined")
            }
        }

        for (var x = 17; x < 24; x++) {
            calendar[keyDate(gendat(12, x))].oid = 'december/' + x
        }

        return calendar;
    }

    function boxChanged(latBox, lonBox, datBox) {
        // this is the main logic loop
        var lat = latBox.value;
        var lon = lonBox.value;
        var dat = datBox.value.replace(/-/g, '\/').split('/');
        
        dat = new Date(dat[0], dat[1] -1 , dat[2])

        console.log(datBox.value.replace(/-/g, '\/'))

        console.log(datBox.value)

        console.log(dat);

        var easterSunday = computus(dat.getFullYear());
        var advent = computus2(dat.getFullYear());

        console.log("================= NEW DATE =================");
        console.log("Today is " + dat.toDateString());
        console.log(dat)

        var calendar = getLiturgicalCalendar(dat.getFullYear());

        console.log("---------------- HORARIUM ----------------");

        suntimes = SunCalc.getTimes(dat, lat, lon);
        for (let x in suntimes) {
            suntimes[x] = dateToSuntime(suntimes[x]);
        }

        suntimes = SunCalc.getTimes(dat, lat, lon);
        for (let x in suntimes) {
            suntimes[x] = dateToSuntime(suntimes[x]);
        }

        var sunrise = suntimes.sunrise;
        var sunset = suntimes.sunset;

        var dayhours = (sunset - sunrise) / 12;
        var nighthours = (sunrise - sunset + 24) / 12;

        console.log("Sunrise is at " + printClocktime(suntimeToClocktime(sunrise)));
        console.log("Day hours are " + printDuration(dayhours) + " long");
        console.log("Night hours are " + printDuration(nighthours) + " long");

        var today = calendar[keyDate(dat)]
        var tomorrow = calendar[keyDate(advdat(new Date(dat)))];

        var m1 = queryTMeta(today);
        var m2 = queryTMeta(tomorrow);
        
        var today_minus_saint = JSON.parse(JSON.stringify(today));
        delete today_minus_saint.stid;
        console.log(today_minus_saint)

        var m3 = queryTMeta(today_minus_saint)

        console.log("Today is " + today.id);
        console.log("Tomorrow is " + tomorrow.id)

        m2.penance = m1.penance;
        m3.penance = m2.penance; // this is necessary to ensure proper supper/dinner after first vespers

        var firstVespers = (m2.rank < 7); // whether tomorrow has first vespers
        var secondVespers = (m1.rank != 6 && m1.rank != 5); // whether today has vespers

        var higherFeast = m2.rank < m1.rank; // whether tomorrow is a greater feast

        var separateVespers; // whether to separate Vespers and Compline
        var feriaVespers = !higherFeast; // if separateVespers, whether to use the ferial (m3)
                            // if false, uses with saints (m2)

        if (secondVespers && firstVespers) {
            console.log('Today has Vespers, and tomorrow has first Vespers.')
            if (higherFeast) {
                console.log("Vespers and Compline of tomorrow")
                separateVespers = true;
            } else {
                console.log("Vespers and Compline of today")
                separateVespers = false;
            }
        } else if (!secondVespers && firstVespers) {
            console.log('Today has no Vespers, but tomorrow has first Vespers.')
            console.log('Vespers and Compline of tomorrow')
            separateVespers = true;
            feriaVespers = false;
        } else if (secondVespers && !firstVespers) {
            console.log('Today has second Vespers and tomorrow has no first Vespers.')
            console.log('Vespers and Compline of today.')
            separateVespers = false;
        } else {
            console.log('Today has no Vespers and tomorrow has no first Vespers.')
            console.log('We will default to ferial!')
            separateVespers = true;
            feriaVespers = true
        }

        console.log('separateVespers = ' + separateVespers + ', feriaVespers = ' + feriaVespers)

        let hours = {
            Vigils: {
                time: roundTime(suntimes.nadir),
                duration: 1.5,
                liturgy: today,
                metadata: m1
            },
            Lauds: {
                time: roundTime(suntimes.nauticalDawn),
                duration: 0.75,
                liturgy: today,
                metadata: m1
            },
            Prime: {
                time: roundTime(sunrise + dayhours * 1),
                duration: 0.25,
                liturgy: today,
                metadata: m1
            },
            Terce: {
                time: roundTime(sunrise + dayhours * 3),
                duration: 0.25,
                liturgy: today,
                metadata: m1
            },
            Sext: {
                time: roundTime(sunrise + dayhours * 6),
                duration: 0.25,
                liturgy: today,
                metadata: m1
            },
            None: {
                time: roundTime(sunrise + dayhours * 9),
                duration: 0.25,
                liturgy: today,
                metadata: m1
            },
            Vespers: {
                time: roundTime(sunset),
                duration: 0.5,
                liturgy: separateVespers ? (feriaVespers ? today_minus_saint : tomorrow) : today,
                metadata: separateVespers ? (feriaVespers ? m3 : m2) : m1
            },
            Compline: {
                time: roundTime(suntimes.night),
                duration: 0.5,
                liturgy: separateVespers ? (feriaVespers ? today_minus_saint : tomorrow) : today,
                metadata: separateVespers ? (feriaVespers ? m3 : m2) : m1
            },
        };

        console.log(hours)

        var table = getHorariumTable(hours, (separateVespers));
        let content = document.getElementById("content");
        let fasting = document.createElement('p');
        let notes = document.createElement('p');
        let heading = document.createElement("h2");
        heading.style.fontWeight = "bold";
        heading.innerHTML = m1.name;
        heading.style.color = m1.color;
        if (m1.color == 'white') {
            //heading.style.textShadow = '0.5px 0.5px 0 #000,-0.5px 0.5px 0 #000, -0.5px -0.5px 0 #000, 0.5px -0.5px 0 #000'
            heading.style['-webkit-text-stroke'] = '0.75px black';
        } else if (m1.color == 'blue') {
            heading.style.color = '#2B4593'
        }

        switch (m1.penance) {
        case 'fast': {
            fasting.innerHTML = '<b>Fasting.</b> Refrain from meat, fish, dairy, and eggs.'
            break;
        }
        case 'abstinence': {
            fasting.innerHTML = '<b>Abstinence.</b> Refrain from meat, dairy, and eggs.'
            break;
        }
        case 'strict-fast': // same as vigil
        case 'vigil': {
            fasting.innerHTML = '<b>Fasting.</b> Refrain from meat, fish, oil, wine, dairy, and eggs.'
            break;
        }
        default:
            fasting.innerHTML = '<b>No penance.</b>'
        }

        notes.innerHTML += '<b>Notes. </b>' + m1.note;


        content.innerHTML = "";
        content.append(heading);
        content.append(fasting);
        if (m1.note != undefined) content.append(notes);
        content.append(table);

        if (separateVespers) {
            for (x in hours) {
                if (x == 'Vespers' || x == 'Compline') continue;
                delete hours[x]
            }

            let table = getHorariumTable(hours, false, feriaVespers ? true : !separateVespers);
                                                // whether to print vespers & compile spearetely
                                                        // if true, "Vespers", if false, "First Vespers"
            let heading = document.createElement("h2");
            heading.style.fontWeight = "bold";
            heading.innerHTML = (feriaVespers) ? m3.name : m2.name;
            heading.style.color = (feriaVespers) ? m3.color : m2.color;
            if (heading.style.color == 'white') {
                //heading.style.textShadow = '0.5px 0.5px 0 #000,-0.5px 0.5px 0 #000, -0.5px -0.5px 0 #000, 0.5px -0.5px 0 #000'
                heading.style['-webkit-text-stroke'] = '0.75px black';
            } else if (heading.style.color == 'blue') {
            heading.style.color = '#2B4593'
        }

            content.append(heading);
            content.append(fasting.cloneNode(true))
            content.append(table);
        }

        document.body.append(content);

        console.log("============================================");
    }


    function displayRibbons(date, hour) {
        document.body.innerHTML = ''
        console.log(date.toDateString() + ' @ ' + hour)

        var calendar = getLiturgicalCalendar(date.getFullYear())
        var today = calendar[keyDate(date)]
        var meta = queryTMeta(today)
        console.log(meta)

        let heading = document.createElement('h2')
        heading.innerHTML = meta.name;
        heading.style.color = meta.color;
        if (meta.color == 'white') {
            //heading.style.textShadow = '0.5px 0.5px 0 #000,-0.5px 0.5px 0 #000, -0.5px -0.5px 0 #000, 0.5px -0.5px 0 #000'
            heading.style['-webkit-text-stroke'] = '0.75px black';
        } else if (meta.color == 'blue') {
            heading.style.color = '#2B4593'
        }

        document.body.append(heading)

        let hourheading = document.createElement('h3')
        hourheading.innerHTML = 'At ' + hour;
        heading.style.fontWeight = "bold";
        if (hour == 'FirstVespers') {
            hourheading.innerHTML = 'At First Vespers';
        }

        document.body.append(hourheading)

        let returnp = document.createElement('p');
        returnp.innerHTML = 'Return to the <a href="?">horarium.</a>'
        document.body.append(returnp)
    }
</script>

<html>
    <head>
        <title>Horarium</title>
        <style>
            body {
                margin: 5%;
                font-size: 18px;
            }
            td,
            th {
                padding: 1%;
            }
            .info {
               /* font-size: 12px; */
               float: right;
            }
        </style>
    </head>
    <body>
        <form>
            <label for="lat" visible='false'>Latitude</label>
            <input type="number" id="lat" visible='false'/>
            <label for="lon">Longitude</label>
            <input type="number" id="lon" />
            <label for="dat">Date</label>
            <input type="date" id="dat" />
        </form>
        <div id="content">
            <p>Waiting for geolocation.</p>
        </div>
    </body>

    <script>
        let params = new URLSearchParams(window.location.search);
        if (params.get('hour') == undefined || params.get('date') == undefined) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (pos) {
                        initBoxes(pos.coords.latitude, pos.coords.longitude);
                    },
                    function () {
                        alert("Geolocation failed. Manual entry is required.");
                        initBoxes(0, 0);
                    }
                );
            } else {
                alert("Geolocation is not supported on this device. Manual entry is required.");
                initBoxes(0, 0);
            }
        } else {
            let date = new Date();
            let parts = params.get('date').split('/');
            date.setFullYear(parts[0])
            date.setMonth(parts[1] - 1)
            date.setDate(parts[2])

            displayRibbons(date, params.get('hour'));
        }
    </script>
</html>
